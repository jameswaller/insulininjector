<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Insulin" />
  <meta name="theme-color" content="#f5f4f0" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#0d1117" media="(prefers-color-scheme: dark)" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <title>Insulin Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Geist+Mono:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    /* ‚îÄ‚îÄ Tokens ‚îÄ‚îÄ */
    :root {
      --radius: 24px;
      --radius-sm: 12px;
      --transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1);

      /* Light */
      --bg: #f5f4f0;
      --bg-card: #ffffff;
      --bg-muted: #eeecea;
      --border: rgba(0,0,0,0.07);
      --text-primary: #0d0c0a;
      --text-secondary: #6b6860;
      --text-tertiary: #a8a6a2;
      --shadow: 0 2px 24px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 48px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.06);

      /* Accent ‚Äî left: cool blue, right: warm amber */
      --left-hue: 210;
      --right-hue: 28;
      --left: hsl(210, 85%, 52%);
      --left-soft: hsl(210, 85%, 96%);
      --left-glow: hsla(210, 85%, 52%, 0.18);
      --right: hsl(28, 90%, 52%);
      --right-soft: hsl(28, 90%, 95%);
      --right-glow: hsla(28, 90%, 52%, 0.18);
      --done: hsl(145, 60%, 42%);
      --done-soft: hsl(145, 60%, 94%);
    }

    [data-theme="dark"], @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #0d1117;
        --bg-card: #161b22;
        --bg-muted: #1c2128;
        --border: rgba(255,255,255,0.07);
        --text-primary: #f0ede8;
        --text-secondary: #8b949e;
        --text-tertiary: #484f58;
        --shadow: 0 2px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3);
        --shadow-lg: 0 8px 48px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3);
        --left-soft: hsla(210, 85%, 52%, 0.12);
        --right-soft: hsla(28, 90%, 52%, 0.12);
        --done-soft: hsla(145, 60%, 42%, 0.12);
      }
    }

    [data-theme="dark"] {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-muted: #1c2128;
      --border: rgba(255,255,255,0.07);
      --text-primary: #f0ede8;
      --text-secondary: #8b949e;
      --text-tertiary: #484f58;
      --shadow: 0 2px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 48px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3);
      --left-soft: hsla(210, 85%, 52%, 0.12);
      --right-soft: hsla(28, 90%, 52%, 0.12);
      --done-soft: hsla(145, 60%, 42%, 0.12);
    }

    [data-theme="light"] {
      --bg: #f5f4f0;
      --bg-card: #ffffff;
      --bg-muted: #eeecea;
      --border: rgba(0,0,0,0.07);
      --text-primary: #0d0c0a;
      --text-secondary: #6b6860;
      --text-tertiary: #a8a6a2;
      --shadow: 0 2px 24px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 48px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.06);
      --left-soft: hsl(210, 85%, 96%);
      --right-soft: hsl(28, 90%, 95%);
      --done-soft: hsl(145, 60%, 94%);
    }

    /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { height: 100%; }

    body {
      font-family: 'Geist Mono', monospace;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: max(env(safe-area-inset-top), 24px) 20px max(env(safe-area-inset-bottom), 24px);
      transition: background var(--transition), color var(--transition);
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
      margin-bottom: 4px;
    }

    .app-name {
      font-family: 'Playfair Display', serif;
      font-size: 13px;
      font-weight: 300;
      color: var(--text-tertiary);
      letter-spacing: 0.05em;
    }

    .theme-toggle {
      background: var(--bg-muted);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: background var(--transition), transform 0.2s;
      color: var(--text-secondary);
    }

    .theme-toggle:hover { transform: rotate(20deg); }

    /* ‚îÄ‚îÄ Main card ‚îÄ‚îÄ */
    .main-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 36px 32px 32px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      position: relative;
      overflow: hidden;
      transition: background var(--transition), box-shadow var(--transition);
    }

    /* Subtle color wash behind the card based on side */
    .main-card::before {
      content: '';
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      height: 280px;
      border-radius: 50%;
      opacity: 0.5;
      transition: background var(--transition);
      pointer-events: none;
    }

    .main-card.side-left::before  { background: radial-gradient(circle, var(--left-glow), transparent 70%); }
    .main-card.side-right::before { background: radial-gradient(circle, var(--right-glow), transparent 70%); }
    .main-card.side-done::before  { background: radial-gradient(circle, hsla(145,60%,42%,0.12), transparent 70%); }

    .date-line {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 32px;
      position: relative;
    }

    .tonight-label {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 14px;
      position: relative;
    }

    /* ‚îÄ‚îÄ Big side pill ‚îÄ‚îÄ */
    .side-pill {
      position: relative;
      margin-bottom: 10px;
      padding-bottom: 12px;
    }

    .side-text {
      font-family: 'Playfair Display', serif;
      font-size: clamp(60px, 18vw, 88px);
      font-weight: 600;
      line-height: 1.2;
      letter-spacing: -0.03em;
      transition: color var(--transition);
    }

    .main-card.side-left  .side-text { color: var(--left); }
    .main-card.side-right .side-text { color: var(--right); }
    .main-card.side-done  .side-text { color: var(--done); }

    .side-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      padding: 5px 12px;
      border-radius: 999px;
      margin-bottom: 36px;
      transition: background var(--transition), color var(--transition);
    }

    .main-card.side-left  .side-badge { background: var(--left-soft); color: var(--left); }
    .main-card.side-right .side-badge { background: var(--right-soft); color: var(--right); }
    .main-card.side-done  .side-badge { background: var(--done-soft); color: var(--done); }

    /* ‚îÄ‚îÄ Primary button ‚îÄ‚îÄ */
    .btn-primary {
      width: 100%;
      padding: 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: 'Geist Mono', monospace;
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }

    .main-card.side-left  .btn-primary { background: var(--left); color: #fff; }
    .main-card.side-right .btn-primary { background: var(--right); color: #fff; }
    .main-card.side-done  .btn-primary { background: var(--done-soft); color: var(--done); }

    .btn-primary:hover:not(:disabled) { filter: brightness(1.08); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .btn-primary:active { transform: translateY(0); }

    .btn-undo {
      background: none;
      border: none;
      font-family: 'Geist Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 10px;
      margin-top: 2px;
      transition: color 0.2s;
      opacity: 0;
      pointer-events: none;
    }

    .main-card.side-done .btn-undo { opacity: 1; pointer-events: all; }
    .btn-undo:hover { color: var(--text-secondary); }

    /* ‚îÄ‚îÄ Streak chip ‚îÄ‚îÄ */
    .streak-chip {
      display: none;
      align-self: flex-end;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      box-shadow: var(--shadow);
      margin-bottom: -4px;
    }

    .streak-chip.visible { display: block; }
    .streak-chip strong { color: var(--done); font-weight: 500; }

    /* ‚îÄ‚îÄ Settings card ‚îÄ‚îÄ */
    .settings-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: background var(--transition);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      gap: 16px;
    }

    .settings-row + .settings-row {
      border-top: 1px solid var(--border);
    }

    .settings-label {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .settings-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-input {
      background: var(--bg-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'Geist Mono', monospace;
      font-size: 16px;
      padding: 7px 12px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s, background var(--transition);
    }

    .time-input:focus { border-color: var(--left); }

    /* Small button */
    .btn-sm {
      background: var(--bg-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-family: 'Geist Mono', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 7px 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-sm:hover { background: var(--border); color: var(--text-primary); }
    .btn-sm.saved { color: var(--done); border-color: var(--done-soft); }

    /* Notification toggle button */
    .notif-status-text {
      font-size: 10px;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
      text-align: right;
      flex: 1;
    }

    .notif-status-text.active { color: var(--done); }
    .notif-status-text.blocked { color: hsl(0,70%,55%); }

    .btn-notif {
      background: var(--bg-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-family: 'Geist Mono', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 7px 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-notif:hover { background: var(--border); color: var(--text-primary); }
    .btn-notif.enabled { background: var(--done-soft); color: var(--done); border-color: transparent; }
    .btn-notif:disabled { opacity: 0.4; cursor: default; pointer-events: none; }

    /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
    @keyframes pop {
      0%   { transform: scale(0.92); opacity: 0.6; }
      60%  { transform: scale(1.04); }
      100% { transform: scale(1);    opacity: 1; }
    }

    .side-text.pop { animation: pop 0.38s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .app { animation: fadein 0.5s ease both; }
  </style>
</head>
<body>
  <div class="app">

    <!-- Top bar -->
    <div class="topbar">
      <span class="app-name">Insulin</span>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">‚òÄÔ∏è</button>
    </div>

    <!-- Streak chip -->
    <div class="streak-chip" id="streakChip"></div>

    <!-- Main card -->
    <div class="main-card" id="mainCard">
      <div class="date-line" id="dateLine"></div>
      <div class="tonight-label">Tonight's side</div>
      <div class="side-pill">
        <div class="side-text" id="sideText"></div>
      </div>
      <div class="side-badge" id="sideBadge"></div>
      <button class="btn-primary" id="logBtn"></button>
      <button class="btn-undo" id="undoBtn">undo</button>
    </div>

    <!-- Settings card -->
    <div class="settings-card">
      <!-- Reminder time row -->
      <div class="settings-row">
        <span class="settings-label">Reminder</span>
        <div class="settings-right">
          <input type="time" class="time-input" id="timeInput" />
        </div>
      </div>
      <!-- Notifications row -->
      <div class="settings-row">
        <span class="settings-label">Notifications</span>
        <div class="settings-right">
          <span class="notif-status-text" id="notifStatusText"></span>
          <button class="btn-notif" id="notifBtn"></button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const html = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');

    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function getTheme() {
      return localStorage.getItem('theme') || 'auto';
    }

    function applyTheme(theme) {
      const resolved = theme === 'auto' ? getSystemTheme() : theme;
      html.setAttribute('data-theme', resolved);
      themeToggle.textContent = resolved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    themeToggle.addEventListener('click', () => {
      const current = getTheme();
      const resolved = current === 'auto' ? getSystemTheme() : current;
      const next = resolved === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    applyTheme(getTheme());
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (getTheme() === 'auto') applyTheme('auto');
    });

    // ‚îÄ‚îÄ Date / side logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getChicagoParts() {
      const now = new Date();
      const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Chicago',
        year: 'numeric', month: 'numeric', day: 'numeric'
      }).formatToParts(now);
      const p = {};
      parts.forEach(x => p[x.type] = parseInt(x.value, 10));
      return p;
    }

    function getDOY(year, month, day) {
      const start = new Date(Date.UTC(year, 0, 1));
      const cur   = new Date(Date.UTC(year, month - 1, day));
      return Math.floor((cur - start) / 86400000) + 1;
    }

    function getTonightSide() {
      const { year, month, day } = getChicagoParts();
      const doy = getDOY(year, month, day);
      return doy % 2 === 0 ? 'Left' : 'Right';
    }

    function getStorageKey() {
      const { year, month, day } = getChicagoParts();
      return `done_${year}_${getDOY(year, month, day)}`;
    }

    function isDoneToday() {
      return localStorage.getItem(getStorageKey()) === '1';
    }

    function markDone() {
      localStorage.setItem(getStorageKey(), '1');
      const { year, month, day } = getChicagoParts();
      const doy  = getDOY(year, month, day);
      const prev = parseInt(localStorage.getItem('streak_doy') || '0', 10);
      const prevYear = parseInt(localStorage.getItem('streak_year') || '0', 10);
      let streak = parseInt(localStorage.getItem('streak') || '0', 10);
      if ((prev === doy - 1 && prevYear === year) || (doy === 1 && prev >= 364)) {
        streak += 1;
      } else {
        streak = 1;
      }
      localStorage.setItem('streak', streak);
      localStorage.setItem('streak_doy', doy);
      localStorage.setItem('streak_year', year);
    }

    function undoDone() { localStorage.removeItem(getStorageKey()); }

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const mainCard   = document.getElementById('mainCard');
    const dateLine   = document.getElementById('dateLine');
    const sideText   = document.getElementById('sideText');
    const sideBadge  = document.getElementById('sideBadge');
    const logBtn     = document.getElementById('logBtn');
    const undoBtn    = document.getElementById('undoBtn');
    const streakChip = document.getElementById('streakChip');

    function render() {
      const side = getTonightSide();
      const done = isDoneToday();
      const { year, month, day } = getChicagoParts();

      dateLine.textContent = new Date(year, month - 1, day)
        .toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

      sideText.textContent = side;

      mainCard.className = 'main-card ' + (done ? 'side-done' : 'side-' + side.toLowerCase());

      if (done) {
        sideBadge.textContent = '‚úì Logged for tonight';
        logBtn.textContent = 'Done for tonight';
      } else {
        sideBadge.textContent = side + ' injection site';
        logBtn.textContent = 'Mark as done';
      }

      const streak = parseInt(localStorage.getItem('streak') || '0', 10);
      if (streak > 1) {
        streakChip.innerHTML = `üî• <strong>${streak}</strong> day streak`;
        streakChip.classList.add('visible');
      } else {
        streakChip.classList.remove('visible');
      }
    }

    logBtn.addEventListener('click', () => {
      if (isDoneToday()) return;
      markDone();
      sideText.classList.remove('pop');
      void sideText.offsetWidth;
      sideText.classList.add('pop');
      render();
    });

    undoBtn.addEventListener('click', () => { undoDone(); render(); });

    // ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const notifBtn        = document.getElementById('notifBtn');
    const notifStatusText = document.getElementById('notifStatusText');
    const timeInput       = document.getElementById('timeInput');

    function getSavedTime() { return localStorage.getItem('notif_time') || '21:00'; }

    function getTimeLabel(t) {
      const [h, m] = (t || getSavedTime()).split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      return `${h % 12 || 12}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    timeInput.value = getSavedTime();

    timeInput.addEventListener('change', async () => {
      const val = timeInput.value;
      if (!val) return;
      localStorage.setItem('notif_time', val);
      if (localStorage.getItem('notif_enabled') === '1') await sendTimeToSW(val);
      updateNotifUI();
    });

    async function sendTimeToSW(time) {
      try {
        if (!('serviceWorker' in navigator)) return;
        const reg = await navigator.serviceWorker.ready;
        if (reg.active) reg.active.postMessage({ type: 'SET_TIME', time });
      } catch(e) { console.warn('SW postMessage failed:', e); }
    }

    function updateNotifUI() {
      const supported = ('Notification' in window) && ('serviceWorker' in navigator);
      const enabled = localStorage.getItem('notif_enabled') === '1';
      const time = getTimeLabel();

      // Reset state
      notifBtn.disabled = false;
      notifBtn.classList.remove('enabled');

      if (!supported) {
        notifBtn.textContent = 'Unsupported';
        notifBtn.disabled = true;
        notifStatusText.textContent = 'Requires iOS 16.4+ home screen';
        notifStatusText.className = 'notif-status-text blocked';
        return;
      }

      if (Notification.permission === 'denied') {
        notifBtn.textContent = 'Blocked';
        notifBtn.disabled = true;
        notifStatusText.textContent = 'Enable in iOS Settings';
        notifStatusText.className = 'notif-status-text blocked';
        return;
      }

      if (Notification.permission === 'granted' && enabled) {
        notifBtn.textContent = 'On';
        notifBtn.classList.add('enabled');
        notifStatusText.textContent = `${time} CST`;
        notifStatusText.className = 'notif-status-text active';
      } else {
        notifBtn.textContent = 'Enable';
        notifStatusText.textContent = `${time} CST`;
        notifStatusText.className = 'notif-status-text';
      }
    }

    notifBtn.addEventListener('click', async () => {
      const enabled = localStorage.getItem('notif_enabled') === '1';

      if (enabled) {
        // Turn off
        localStorage.removeItem('notif_enabled');
        updateNotifUI();
        return;
      }

      // Turn on ‚Äî request permission if needed
      try {
        let perm = Notification.permission;
        if (perm === 'default') {
          perm = await Notification.requestPermission();
        }
        if (perm === 'granted') {
          localStorage.setItem('notif_enabled', '1');
          if ('serviceWorker' in navigator) {
            await navigator.serviceWorker.register('sw.js');
            await sendTimeToSW(getSavedTime());
          }
        }
      } catch(e) {
        console.warn('Notification enable failed:', e);
      }
      updateNotifUI();
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('load', async () => {
      render();
      updateNotifUI();
      if (localStorage.getItem('notif_enabled') === '1' && 'serviceWorker' in navigator) {
        await navigator.serviceWorker.register('sw.js');
        await sendTimeToSW(getSavedTime());
      }
    });
  </script>
</body>
</html>
